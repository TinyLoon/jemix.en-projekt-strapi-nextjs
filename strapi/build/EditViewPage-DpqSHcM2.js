import{bp as ue,j as t,cF as pe,k as _,a7 as k,F as E,T as x,G as y,by as B,d1 as W,cC as ge,cD as me,fv as he,d as G,e7 as v,fw as fe,bg as V,c9 as ye,fx as xe,aD as Te,bq as Ae,aE as U,aF as F,fy as ke,d4 as Ee,fz as be,d5 as Ie,bL as je,az as J,P as M,w as Ce,ao as Se,f as m,p as _e,bo as Pe,z as ve,ai as Re,v as Oe,aj as Le,b3 as Me,b4 as Ne,B as we,aH as Y}from"./strapi-w3l9_OYo.js";import{b as $e,c as De,d as Ue}from"./apiTokens-CzG94eKt.js";import{A as P}from"./constants-Q2dfXdfa.js";import{a as Fe,b as Be,L as Ge,c as He,F as qe,T as Ve}from"./TokenTypeSelect-CUxGcifX.js";import{_ as Ye}from"./_baseMap-FzRmIcy-.js";import"./transferTokens-D2_7NAAt.js";import"./index-Dsny0Fvz.js";import"./index-BRVyLNfZ.js";import"./_baseEach-B7vKpw-x.js";const ze=ue.injectEndpoints({endpoints:e=>({getPermissions:e.query({query:()=>"/admin/content-api/permissions",transformResponse:s=>s.data}),getRoutes:e.query({query:()=>"/admin/content-api/routes",transformResponse:s=>s.data})}),overrideExisting:!1}),{useGetPermissionsQuery:Ke,useGetRoutesQuery:Qe}=ze,[We,Je]=pe("ApiTokenPermissionsContext"),Xe=({children:e,...s})=>t.jsx(We,{...s,children:e}),H=()=>Je("useApiTokenPermissions"),Ze=({errors:e={},onChange:s,canEditInputs:n,isCreating:i,values:a={},apiToken:u={},onDispatch:c,setHasChangedPermissions:h})=>{const{formatMessage:o}=_(),p=({target:{value:l}})=>{h(!1),l==="full-access"&&c({type:"SELECT_ALL_ACTIONS"}),l==="read-only"&&c({type:"ON_CHANGE_READ_ONLY"})},b=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return t.jsx(k,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:t.jsxs(E,{direction:"column",alignItems:"stretch",gap:4,children:[t.jsx(x,{variant:"delta",tag:"h2",children:o({id:"global.details",defaultMessage:"Details"})}),t.jsxs(y.Root,{gap:5,children:[t.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:t.jsx(Fe,{error:e.name,value:a.name,canEditInputs:n,onChange:s})},"name"),t.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:t.jsx(Be,{error:e.description,value:a.description,canEditInputs:n,onChange:s})},"description"),t.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:t.jsx(Ge,{isCreating:i,error:e.lifespan,value:a.lifespan,onChange:s,token:u})},"lifespan"),t.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:t.jsx(He,{value:a.type,error:e.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:l=>{p({target:{value:l}}),s({target:{name:"type",value:l}})},options:b,canEditInputs:n})},"type")]})]})})};var es=W,ss=ge,ts=Ye,ns=me;function as(e,s){var n=ns(e)?es:ts;return n(e,ss(s))}var is=as;const rs=B(is);var os=he;function cs(e){var s=e==null?0:e.length;return s?os(e,1,s):[]}var ls=cs;const ds=B(ls),us=e=>{switch(e){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},ps=G(k)`
  margin: -1px;
  border-radius: ${({theme:e})=>e.spaces[1]} 0 0 ${({theme:e})=>e.spaces[1]};
`,gs=({route:e={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:s}=_(),{method:n,handler:i,path:a}=e,u=a?ds(a.split("/")):[],[c="",h=""]=i?i.split("."):[],o=us(e.method);return t.jsxs(E,{direction:"column",alignItems:"stretch",gap:2,children:[t.jsxs(x,{variant:"delta",tag:"h3",children:[s({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"Â ",t.jsx("span",{children:c}),t.jsxs(x,{variant:"delta",textColor:"primary600",children:[".",h]})]}),t.jsxs(E,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[t.jsx(ps,{background:o.background,borderColor:o.border,padding:2,children:t.jsx(x,{fontWeight:"bold",textColor:o.text,children:n})}),t.jsx(k,{paddingLeft:2,paddingRight:2,children:rs(u,p=>t.jsxs(x,{textColor:p.includes(":")?"neutral600":"neutral900",children:["/",p]},p))})]})]})},ms=()=>{const{value:{selectedAction:e,routes:s}}=H(),{formatMessage:n}=_(),i=e?.split(".")[0];return t.jsx(y.Item,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},direction:"column",alignItems:"stretch",children:e?t.jsx(E,{direction:"column",alignItems:"stretch",gap:2,children:i&&i in s&&s[i].map(a=>a.config.auth?.scope?.includes(e)||a.handler===e?t.jsx(gs,{route:a},a.handler):null)}):t.jsxs(E,{direction:"column",alignItems:"stretch",gap:2,children:[t.jsx(x,{variant:"delta",tag:"h3",children:n({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),t.jsx(x,{tag:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},z=xe`
  background: ${e=>e.theme.colors.primary100};

  #cog {
    opacity: 1;
  }
`,hs=G(k)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  #cog {
    opacity: 0;
    path {
      fill: ${e=>e.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${e=>e.$isActive&&z}
  &:hover {
    ${z}
  }
`,fs=G.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:e})=>e.colors.neutral150};
`,ys=({controllers:e=[],label:s,orderNumber:n=0,disabled:i=!1})=>{const{value:{onChangeSelectAll:a,onChange:u,selectedActions:c,setSelectedAction:h,selectedAction:o}}=H(),{formatMessage:p}=_(),b=l=>l===o;return t.jsxs(v.Item,{value:`${s}-${n}`,children:[t.jsx(v.Header,{variant:n%2?"primary":"secondary",children:t.jsx(v.Trigger,{children:fe(s)})}),t.jsx(v.Content,{children:e?.map(l=>{const R=l.actions.every(g=>c.includes(g.actionId)),N=l.actions.some(g=>c.includes(g.actionId));return t.jsxs(k,{children:[t.jsxs(E,{justifyContent:"space-between",alignItems:"center",padding:4,children:[t.jsx(k,{paddingRight:4,children:t.jsx(x,{variant:"sigma",textColor:"neutral600",children:l?.controller})}),t.jsx(fs,{}),t.jsx(k,{paddingLeft:4,children:t.jsx(V,{checked:!R&&N?"indeterminate":R,onCheckedChange:()=>{a({target:{value:[...l.actions]}})},disabled:i,children:p({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),t.jsx(y.Root,{gap:4,padding:4,children:l?.actions&&l?.actions.map(g=>t.jsx(y.Item,{col:6,direction:"column",alignItems:"stretch",children:t.jsxs(hs,{$isActive:b(g.actionId),padding:2,hasRadius:!0,children:[t.jsx(V,{checked:c.includes(g.actionId),name:g.actionId,onCheckedChange:()=>{u({target:{value:g.actionId}})},disabled:i,children:g.action}),t.jsx("button",{type:"button","data-testid":"action-cog",onClick:()=>h({target:{value:g.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:t.jsx(ye,{id:"cog"})})]})},g.actionId))})]},`${s}.${l?.controller}`)})})]})},xs=({section:e=null,...s})=>t.jsx(k,{children:t.jsx(v.Root,{size:"M",children:e&&e.map((n,i)=>t.jsx(ys,{label:n.label,controllers:n.controllers,orderNumber:i,...s},n.apiId))})}),Ts=({...e})=>{const{value:{data:s}}=H(),{formatMessage:n}=_();return t.jsxs(y.Root,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[t.jsxs(y.Item,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,direction:"column",alignItems:"stretch",gap:6,children:[t.jsxs(E,{direction:"column",alignItems:"stretch",gap:2,children:[t.jsx(x,{variant:"delta",tag:"h2",children:n({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),t.jsx(x,{tag:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),s?.permissions&&t.jsx(xs,{section:s?.permissions,...e})]}),t.jsx(ms,{})]})},As=Te().shape({name:U().max(100).required(F.required.id),type:U().oneOf(["read-only","full-access","custom"]).required(F.required.id),description:U().nullable(),lifespan:Ae().integer().min(0).nullable().defined(F.required.id)});function ks(e,s,n,i){for(var a=n-1,u=e.length;++a<u;)if(i(e[a],s))return a;return-1}var Es=ks,bs=W,Is=be,js=Es,Cs=Ee,Ss=ke,_s=Array.prototype,K=_s.splice;function Ps(e,s,n,i){var a=i?js:Is,u=-1,c=s.length,h=e;for(e===s&&(s=Ss(s)),n&&(h=bs(e,Cs(n)));++u<c;)for(var o=0,p=s[u],b=n?n(p):p;(o=a(h,b,o,i))>-1;)h!==e&&K.call(h,o,1),K.call(e,o,1);return e}var vs=Ps,Rs=vs;function Os(e,s){return e&&e.length&&s&&s.length?Rs(e,s):e}var Ls=Os,Ms=Ie,Ns=Ls,ws=Ms(Ns),$s=ws;const Q=B($s),Ds=e=>{const s={allActionsIds:[],permissions:[]};return s.permissions=Object.entries(e).map(([n,i])=>({apiId:n,label:n.split("::")[1],controllers:Object.keys(i.controllers).map(a=>({controller:a,actions:a in i.controllers?i.controllers[a].map(u=>{const c=`${n}.${a}.${u}`;return n.includes("api::")&&s.allActionsIds.push(c),{action:u,actionId:c}}).flat():[]})).flat()})),s},Us={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},Fs=(e,s)=>je(e,n=>{switch(s.type){case"ON_CHANGE":{n.selectedActions.includes(s.value)?Q(n.selectedActions,s.value):n.selectedActions.push(s.value);break}case"SELECT_ALL_IN_PERMISSION":{s.value.every(a=>n.selectedActions.includes(a.actionId))?s.value.forEach(a=>{Q(n.selectedActions,a.actionId)}):s.value.forEach(a=>{n.selectedActions.push(a.actionId)});break}case"SELECT_ALL_ACTIONS":{n.selectedActions=[...n.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const i=n.data.allActionsIds.filter(a=>a.includes("find")||a.includes("findOne"));n.selectedActions=[...i];break}case"UPDATE_PERMISSIONS_LAYOUT":{n.data=Ds(s.value);break}case"UPDATE_ROUTES":{n.routes={...s.value};break}case"UPDATE_PERMISSIONS":{n.selectedActions=[...s.value];break}case"SET_SELECTED_ACTION":{n.selectedAction=s.value;break}default:return n}}),Bs=()=>{const{formatMessage:e}=_(),{toggleNotification:s}=Ce(),{state:n}=Se(),i=J(r=>r.admin_app.permissions),[a,u]=m.useState(n?.apiToken?.accessKey?{...n.apiToken}:null),[c,h]=m.useState(!!n?.apiToken?.accessKey),o=m.useRef(null),{trackUsage:p}=_e(),b=Pe("EditView",r=>r.setCurrentStep),{allowedActions:{canCreate:l,canUpdate:R,canRegenerate:N}}=ve(i.settings?.["api-tokens"]),[g,f]=m.useReducer(Fs,Us),O=Re("/settings/api-tokens/:id")?.params?.id,T=O==="create",{_unstableFormatAPIError:A,_unstableFormatValidationErrors:q}=Oe(),X=Le(),j=Ke(),C=Qe();m.useEffect(()=>{j.error&&s({type:"danger",message:A(j.error)})},[j.error,A,s]),m.useEffect(()=>{C.error&&s({type:"danger",message:A(C.error)})},[C.error,A,s]),m.useEffect(()=>{j.data&&f({type:"UPDATE_PERMISSIONS_LAYOUT",value:j.data})},[j.data]),m.useEffect(()=>{C.data&&f({type:"UPDATE_ROUTES",value:C.data})},[C.data]),m.useEffect(()=>{a&&(a.type==="read-only"&&f({type:"ON_CHANGE_READ_ONLY"}),a.type==="full-access"&&f({type:"SELECT_ALL_ACTIONS"}),a.type==="custom"&&f({type:"UPDATE_PERMISSIONS",value:a?.permissions}))},[a]),m.useEffect(()=>{p(T?"didAddTokenFromList":"didEditTokenFromList",{tokenType:P})},[T,p]);const{data:I,error:w,isLoading:Z}=$e(O,{skip:!O||T||!!a});m.useEffect(()=>{w&&s({type:"danger",message:A(w)})},[w,A,s]),m.useEffect(()=>{I&&(u(I),I.type==="read-only"&&f({type:"ON_CHANGE_READ_ONLY"}),I.type==="full-access"&&f({type:"SELECT_ALL_ACTIONS"}),I.type==="custom"&&f({type:"UPDATE_PERMISSIONS",value:I?.permissions}))},[I]),m.useEffect(()=>{if(c)return o.current=setTimeout(()=>{h(!1)},3e4),()=>{o.current&&(clearTimeout(o.current),o.current=null)}},[c]);const[ee]=De(),[se]=Ue(),te=async(r,S)=>{p(T?"willCreateToken":"willEditToken",{tokenType:P});try{if(T){const d=await ee({...r,lifespan:r?.lifespan&&r.lifespan!=="0"?parseInt(r.lifespan.toString(),10):null,permissions:r.type==="custom"?g.selectedActions:null});if("error"in d){Y(d.error)&&d.error.name==="ValidationError"?S.setErrors(q(d.error)):s({type:"danger",message:A(d.error)});return}s({type:"success",message:e({id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"})}),p("didCreateToken",{type:d.data.type,tokenType:P}),X(`../api-tokens/${d.data.id.toString()}`,{state:{apiToken:d.data},replace:!0}),b("apiTokens.success")}else{const d=await se({id:O,name:r.name,description:r.description,type:r.type,permissions:r.type==="custom"?g.selectedActions:null});if("error"in d){Y(d.error)&&d.error.name==="ValidationError"?S.setErrors(q(d.error)):s({type:"danger",message:A(d.error)});return}s({type:"success",message:e({id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),p("didEditToken",{type:d.data.type,tokenType:P})}}catch{s({type:"danger",message:e({id:"notification.error",defaultMessage:"Something went wrong"})})}},[ne,$]=m.useState(!1),ae=({target:{value:r}})=>{$(!0),f({type:"ON_CHANGE",value:r})},ie=({target:{value:r}})=>{$(!0),f({type:"SELECT_ALL_IN_PERMISSION",value:r})},re=({target:{value:r}})=>{f({type:"SET_SELECTED_ACTION",value:r})},oe=()=>{h(r=>!r),o.current&&(clearTimeout(o.current),o.current=null)},ce={...g,onChange:ae,onChangeSelectAll:ie,setSelectedAction:re},D=R&&!T||l&&T,le=!!a?.accessKey;return Z?t.jsx(M.Loading,{}):t.jsx(Xe,{value:ce,children:t.jsxs(M.Main,{children:[t.jsx(M.Title,{children:e({id:"Settings.PageTitle",defaultMessage:"Settings - {name}"},{name:"API Tokens"})}),t.jsx(Me,{validationSchema:As,validateOnChange:!1,initialValues:{name:a?.name||"",description:a?.description||"",type:a?.type,lifespan:a?.lifespan},enableReinitialize:!0,onSubmit:(r,S)=>te(r,S),children:({errors:r,handleChange:S,isSubmitting:d,values:L,setFieldValue:de})=>(ne&&L?.type!=="custom"&&de("type","custom"),t.jsxs(Ne,{children:[t.jsx(qe,{title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:a,setToken:u,toggleToken:oe,showToken:c,canEditInputs:D,canRegenerate:N,canShowToken:le,isSubmitting:d,regenerateUrl:"/admin/api-tokens/"}),t.jsx(we.Content,{children:t.jsxs(E,{direction:"column",alignItems:"stretch",gap:6,children:[a?.accessKey&&c&&t.jsx(Ve,{token:a.accessKey,tokenType:P}),t.jsx(Ze,{errors:r,onChange:S,canEditInputs:D,isCreating:T,values:L,apiToken:a,onDispatch:f,setHasChangedPermissions:$}),t.jsx(Ts,{disabled:!D||L?.type==="read-only"||L?.type==="full-access"})]})})]}))})]})})},Xs=()=>{const e=J(s=>s.admin_app.permissions.settings?.["api-tokens"].read);return t.jsx(M.Protect,{permissions:e,children:t.jsx(Bs,{})})};export{Bs as EditView,Xs as ProtectedEditView};
